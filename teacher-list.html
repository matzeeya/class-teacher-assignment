<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../iron-ajax/iron-request.html">
<link rel="import" href="../iron-selector/iron-selector.html">
<link rel="import" href="../app-route/app-route.html">
<link rel="import" href="../app-route/app-location.html">
<link rel="import" href="../neon-animation/web-animations.html">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-radio-group/paper-radio-group.html">
<link rel="import" href="../paper-radio-button/paper-radio-button.html">
<link rel="import" href="../paper-button/paper-button.html">

<link rel="import" href="class-teacher-info.html">
<link rel="import" href="knowledge-category.html">

<link href="https://fonts.googleapis.com/css?family=Itim&amp;subset=thai" rel="stylesheet">

<dom-module id="teacher-list">
  <template>
    <style is="custom-style" include="iron-flex iron-flex-alignment iron-flex-factors">
      :host {
        @apply(--layout-vertical);
      }
      .iron-selected {
        background:#eeeeee;
      }

      /* ---font---- */
      .font-header {
        font-family: 'Itim', cursive;
        font-size: 120%;
        opacity: 0.67;
        height: 50px;
        font-weight: bold;
        border-bottom-width:2px;
        border-bottom-style:solid;
        border-bottom-color:#F44336;
      }
      .font-face {
        font-family: 'Itim', cursive;
        font-size: 120%;
        height: 50px;
      }
      
      .margin-left-style{
        margin-left: 10px;
      }

      paper-dropdown-menu{
        width: 500px;
        margin-left: 10px;
      }

      paper-listbox{
        width: 500px;
      }

      paper-radio-button{
        font-family: 'Itim', cursive;
        font-size: 110%;
      }
    </style>
   
    <app-location route="{{route}}" use-hash-as-path></app-location>
    <app-route route="{{route}}" 
      pattern="/rooms/:level/:room/:classId" data="{{data}}">
    </app-route>

    <!--<div>{{data.level}}/{{data.room}}</div>
    <div>Class ID : {{data.classId}}</div>
    <div>Teacher ID : {{teacherId}}</div>-->
      <div class="layout horizontal center font-header">รายชื่อครูประจำชั้น</div>
      <iron-selector selected-item="{{selectedTeacher}}">
      <template is="dom-repeat" items="{{teacherInClass}}">
        <class-teacher-info token="{{token}}" document="{{item}}">
        </class-teacher-info>
        </template>
      </iron-selector>

      {{teacherSelected}}
      <div class="layout horizontal">
        <paper-button on-click="_remove" raised>Remove</paper-button>
      </div>

      <div class="layout vertical">
        <div class="layout horizontal">
          <paper-dropdown-menu label="รายชื่อครู">
          <paper-listbox slot="dropdown-content" selected="{{teacherId}}" attr-for-selected="name">
            <template is="dom-repeat" items="{{items}}">
            <paper-item name="{{item.value}}">
              {{item.key.2.0}} {{item.key.2.1}}
            </paper-item>
            </template>
          </paper-listbox>
          </paper-dropdown-menu>
        </div>
        <div class="layout horizontal">
          <paper-radio-group selected-item="{{selectedItem}}">
            <paper-radio-button name="a">ครูประจำชั้น</paper-radio-button>
            <paper-radio-button name="b">ครูผู้สอน</paper-radio-button>
          </paper-radio-group>
        </div>
        <div class="layout horizontal">
          <template is="dom-if" if="{{teacherGroup}}">
            <div class="flex-1 font-face">กลุ่มสาระการเรียนรู้ : </div>
            <div class="flex-11">
              <knowledge-category></knowledge-category>
            </div>
          </template>
        </div>
        <div class="layout horizontal">
          <paper-button on-click="_add" raised>Add</paper-button>
        </div>
      </div>

      
  </template>

  <script>
    class TeacherList extends Polymer.Element {
      static get is() { return 'teacher-list'; }
      static get properties() {
        return {
          token: {
            type: String,
          },
          hostId:{
            type: String,
          },
          items:{
            type:Array,
            notify:true,
            value:function() {
              return [];
            }
          },
          teacherGroup:{
            type:Boolean,
            notify:true,
            value:false
          }
        };
      }

      static get observers() {
        return [
          '__executedQuery(token,hostId)',
          '__findTeacherInClass(token,data.classId)',
          '__selectedItem(selectedItem)'
        ]
      }

      __selectedItem(el){
        if(el.name=="b"){
          this.set("teacherGroup",true);
        }
      }

      __executedQuery(token,hostId) {
        if(token == null || hostId == null) return;
        var ele = document.createElement('iron-request'); 
        var self = this;
        ele.send({
          url:"https://maas.nuqlis.com:9000/api/query/teacher_db/hostid",
          body:{"match":[hostId]},
          method:"POST",
          handleAs:"json",
          headers:{
            "Authorization":"JWT "+token,
            "Content-Type":"application/json"
          }
        }).then(function(res) {
          self.set('items',res.response);
        });
      }
      
      __findTeacherInClass(token,classId) {
        if(token == null || classId == null) return;
        var ele = document.createElement('iron-request'); 
        var self = this;
        ele.send({
          url:"https://maas.nuqlis.com:9000/api/query/classteacher/class",
          body:{"match":[classId],"include_doc":true},
          method:"POST",
          handleAs:"json",
          headers:{
            "Authorization":"JWT "+token,
            "Content-Type":"application/json"
          }
        }).then(function(res) {
          var _teachers = [];
          res.response.forEach(function(doc) {
            _teachers.push({'key':doc.value.key,'value':doc.value.doc});
          });
          self.set('teacherInClass',_teachers);
        });
      }

      _add(event) {
        var self = this;
        var alreadySelected = false;
        this.teacherInClass.forEach(function(doc) {
          if(doc.value.teacher_id == self.teacherId) {
            alreadySelected = true;
          }
        });
        if(!alreadySelected) {
          var ele = document.createElement('iron-request'); 
          var self = this;
          var content = {
             "teacher_id":this.teacherId,
             "class_id":this.data.classId,
             "room":this.data.room,
             "host":this.hostId,
             "class":this.data.level
          };
          ele.send({
            url:"https://maas.nuqlis.com:9000/api/dbs/classteacher",
            body:content,
            method:"POST",
            handleAs:"json",
            headers:{
              "Authorization":"JWT "+this.token,
              "Content-Type":"application/json"
            }
          }).then(function(res) {
            if(res.response.ok) {
              self.push('teacherInClass',{
                key:res.response.key,
                value:content
              });
            }
          });
        }
      }

      _remove(event) {
        var self = this;
        var doc = this.selectedTeacher;
        if(doc==null) return;
        doc.classList.remove('iron-selected');
        var ele = document.createElement('iron-request'); 
        var key = doc.document.key;
        ele.send({
          url:"https://maas.nuqlis.com:9000/api/dbs/classteacher/"+key,
          method:"DELETE",
          handleAs:"json",
          headers:{
            "Authorization":"JWT "+self.token,
          }
        }).then(function(res) {
          if(res.response.ok) {
            var index = -1;
            for(var i=0;i<self.teacherInClass.length;i++) {
              if(self.teacherInClass[i].key == key) {
                index = i;
                break;
              }
            }
            if(index != -1) {
              self.splice('teacherInClass',index,1);
              self.set('selectedTeacher',null);
            }
          }
        });
      }
    }

    window.customElements.define(TeacherList.is, TeacherList);
  </script>
</dom-module>
