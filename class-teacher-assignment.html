<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../iron-sessionstorage/iron-sessionstorage.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../iron-ajax/iron-request.html">
<link rel="import" href="../paper-tabs/paper-tabs.html">
<link rel="import" href="teacher-list.html">
<link rel="import" href="room-list.html">
<link rel="import" href="teacher-by-room.html">
<link rel="import" href="secure-component.html">

<dom-module id="class-teacher-assignment">
  <template>
    <style is="custom-style" include="iron-flex iron-flex-alignment iron-flex-factors"> 
      :host {
        @apply(--layout-vertical);
      }
      .main {
        padding-left:50px;
      }
    </style>
     
    <secure-component></secure-component>
     
    <iron-sessionstorage name="userdata" value="{{userData}}">
    </iron-sessionstorage>

    <iron-sessionstorage name="token" use-raw value="{{token}}">
    </iron-sessionstorage>

    <p>From session {{teacher.HostID}}</p>

    <room-list token="{{token}}" host-id="1010720003" 
      app="homevisit" items="{{rooms}}">
    </room-list>

    ห้องในโรงเรียน 1010720003 app=homevisit
    <paper-tabs selected="{{selectedLevel}}" scrollable>
      <template is="dom-repeat" items="{{rooms}}" as="level">
        <paper-tab>{{level.name}}</paper-tab>
      </template> 
    </paper-tabs>

    <div class="layout horizontal">
     <div class="layout vertical">
      <template is="dom-repeat" items="{{selectedClass.room}}">
       <teacher-by-room token="{{token}}" class-id="{{item.key}}" items="{{item.count}}">
       </teacher-by-room>
       <div>Room
         <a href="#/rooms/{{selectedClass.name}}/{{item.room}}/{{item.key}}">
           {{item.room}}
         </a> 
         ({{item.count.length}})
        </div>
        <div>
          
        </div>       
      </template>
     </div>

     <teacher-list token="{{token}}" host-id="1010720003"  class="flex"
       items="{{teachers}}">
     </teacher-list>
    </div>

  </template>

  <script>
    class ClassTeacherAssignment extends Polymer.Element {
      static get is() { return 'class-teacher-assignment'; }
      static get properties() {
        return {
          __findTeacher: {
            type: String,
            computed: '_findTeacher(token,userData)'
          },
          selectedClass: {
            type:Object,
            computed: '__executeSelectedClass(rooms,selectedLevel)'
          }
        };
      }

      __executeSelectedClass(list,idx) {
        return list[idx];
      }

      _findTeacher(token,userData) {
        if(userData.length != 1 || token == null) return;
        var teacher_id = userData[0].value.doc.profile.teacher_id;
        var self = this;
        if(teacher_id) {
          var ele = document.createElement('iron-request');
          ele.send({
            url:"https://maas.nuqlis.com:9000/api/dbs/teacher_db/"+teacher_id,
            method:"GET",
            handleAs:"json",
            headers:{
              "Authorization":"JWT "+token
            }
          }).then(function(res) {
            self.set('teacher',res.response);
          });
        }
      }
    }

    window.customElements.define(ClassTeacherAssignment.is, ClassTeacherAssignment);
  </script>
</dom-module>
