<link rel="import" href="../polymer/polymer-element.html">
<link rel="import" href="../iron-sessionstorage/iron-sessionstorage.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../iron-ajax/iron-request.html">
<link rel="import" href="teacher-list.html">
<link rel="import" href="room-list.html">
<link rel="import" href="secure-component.html">

<dom-module id="class-teacher-assignment">
  <template>
    <style is="custom-style" include="iron-flex iron-flex-alignment iron-flex-factors"> 
      :host {
        @apply(--layout-vertical);
      }
      .main {
        padding-left:50px;
      }
    </style>
     
    <secure-component></secure-component>
     
    <iron-sessionstorage name="userdata" value="{{userData}}">
    </iron-sessionstorage>

    <iron-sessionstorage name="token" use-raw value="{{token}}">
    </iron-sessionstorage>

    <p>From session {{teacher.HostID}}</p>

    <room-list token="{{token}}" host-id="1010720003" app="homevisit" items="{{rooms}}">
    </room-list>

    <div class="layout horizontal">
     <div>
       ห้องในโรงเรียน 1010720003 app=homevisit
       <ol>
        <template is="dom-repeat" items="{{rooms}}" as="level">
         <li>{{level.name}} :
          <template is="dom-repeat" items="{{level.room}}">
           <a href="#/rooms/{{level.name}}/{{item.room}}/{{item.key}}">{{item.room}}</a> / 
          </template>
         </li>
        </template>
       </ol>
      </div>
      <div class="flex main">
       <teacher-list token="{{token}}" host-id="1010720003" items="{{teachers}}">
       </teacher-list>
      </div>
    </div>

  </template>

  <script>
    class ClassTeacherAssignment extends Polymer.Element {
      static get is() { return 'class-teacher-assignment'; }
      static get properties() {
        return {
          __findTeacher: {
            type: String,
            computed: '_findTeacher(token,userData)'
          }
        };
      }

      _findTeacher(token,userData) {
        if(userData.length != 1 || token == null) return;
        var teacher_id = userData[0].value.doc.profile.teacher_id;
        var self = this;
        if(teacher_id) {
          var ele = document.createElement('iron-request');
          ele.send({
            url:"https://maas.nuqlis.com:9000/api/dbs/teacher_db/"+teacher_id,
            method:"GET",
            handleAs:"json",
            headers:{
              "Authorization":"JWT "+token
            }
          }).then(function(res) {
            self.set('teacher',res.response);
          });
        }
      }
    }

    window.customElements.define(ClassTeacherAssignment.is, ClassTeacherAssignment);
  </script>
</dom-module>
